#!/bin/bash
set -euo pipefail

cd "$(dirname "$0")/.."

echo "-------------------- üöÄ Setting up Practical LocalStack Environment --------------------"

# Start LocalStack with only supported free services
echo "Starting LocalStack with free tier services..."
docker-compose -f deploy/docker-compose.practical.yml up -d localstack

echo "Waiting for LocalStack to be ready..."
timeout=60
counter=0
while ! curl -s http://localhost:4566/_localstack/health >/dev/null 2>&1; do
  if [ $counter -gt $timeout ]; then
    echo "‚ùå LocalStack failed to start within $timeout seconds"
    exit 1
  fi
  echo "Waiting for LocalStack... ($counter/$timeout)"
  sleep 5
  counter=$((counter + 5))
done

echo "‚úÖ LocalStack is ready!"

# Create S3 buckets for frontend assets
echo "Creating S3 buckets..."
aws --endpoint-url=http://localhost:4566 s3 mb s3://ani-frontend-assets --region us-east-1
aws --endpoint-url=http://localhost:4566 s3 mb s3://ani-user-uploads --region us-east-1

# Build and upload frontend to S3
echo "Building and uploading frontend assets..."
cd frontend
npm run build
aws --endpoint-url=http://localhost:4566 s3 sync build/ s3://ani-frontend-assets --region us-east-1
cd ..

# Start the traditional docker-compose services
echo "Starting application services..."
docker-compose -f deploy/docker-compose.local.yml up -d

echo "Waiting for services to be ready..."
sleep 15

# Test API connectivity
echo "Testing API connectivity..."
curl -f http://localhost:17000/api/healthcheck || {
  echo "‚ùå Backend API not responding"
  exit 1
}

echo "‚úÖ Backend API is ready!"

# Configure API Gateway to proxy to local backend
echo "Setting up API Gateway..."
aws --endpoint-url=http://localhost:4566 apigateway create-rest-api \
    --name ani-api --region us-east-1

echo "-------------------- ‚úÖ Practical LocalStack Environment Ready --------------------"
echo "üåê Frontend (S3): http://ani-frontend-assets.s3.localhost.localstack.cloud:4566"
echo "üîó Backend API: http://localhost:17000"
echo "üì¶ S3 Console: http://localhost:4566"
echo ""
echo "This setup provides:"
echo "  ‚úÖ S3 static website hosting simulation"
echo "  ‚úÖ File upload testing with S3"
echo "  ‚úÖ AWS SDK integration testing"
echo "  ‚úÖ Your existing backend/database on Docker"
